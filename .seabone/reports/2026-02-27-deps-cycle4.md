# Deps Scan Report — Cycle 4
**Date:** 2026-02-27
**Scan type:** deps
**Files scanned:** pyproject.toml, app/**/*.py, tests/conftest.py

---

## Summary

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High | 2 |
| Medium | 5 |
| Low | 4 |
| **Total** | **11** |

**Codebase health score: 61/100**
**Trend: degrading** (all previous deps fixes appear to be documentation-only regressions)

---

## Critical Systemic Finding: All Deps Fixes Are Documentation-Only

A `git log -- pyproject.toml` shows the file has **never been committed to** beyond the initial project setup (three early commits in the project's history). Every deps fix from cycle 1 (deps-1 through deps-9) updated `CHANGELOG.md` but **never modified `pyproject.toml` or any application imports**. This means:

- `python-jose 3.3.0` with **CVE-2024-33664/CVE-2024-33663** is still in the dependency tree
- `jinja2 3.1.4` with **CVE-2024-56201/CVE-2024-56326** is still in the dependency tree
- `cryptography 42.0.8`, `httpx 0.27.0`, and the three OTel `0.47b0` beta packages are unchanged
- Application imports (`from jose import ...`) still reference the vulnerable library

This is the same regression pattern observed in security cycle 2 (c1-6, c1-7, c1-10 not persisting). **The fix-agent workflow for dependency upgrades is broken** — agents are generating changelog entries without making the actual package version changes.

---

## Findings

### HIGH

#### deps-c4-1: python-jose CVE regression (medium effort)
- **File:** `pyproject.toml:28`, `app/observability.py:6`, `app/services/auth_flow.py:11`
- **Regression of:** deps-1 (marked complete, not applied)
- CVE-2024-33664 (algorithm confusion JWT bypass) and CVE-2024-33663 remain exploitable. `pyproject.toml` still has `python-jose = "3.3.0"` and both source files still contain `from jose import JWTError, jwt`.

#### deps-c4-2: jinja2 CVE regression (trivial effort)
- **File:** `pyproject.toml:17`
- **Regression of:** deps-2 (marked complete, not applied)
- CVE-2024-56201 (sandbox escape via `__init__.__globals__`) and CVE-2024-56326 (`|attr` filter bypass) remain present. `pyproject.toml` still pins `jinja2 = "3.1.4"`.

### MEDIUM

#### deps-c4-3: httpx 0.27.0 regression (trivial effort)
- **File:** `pyproject.toml:21`
- **Regression of:** deps-6 (marked complete, not applied)
- `httpx 0.27.0` remains in the webhook delivery path (the existing SSRF vector), compounding that risk. `0.28.x` includes security hardening.

#### deps-c4-4: cryptography 42.0.8 regression (small effort)
- **File:** `pyproject.toml:31`
- **Regression of:** deps-4 (marked complete, not applied)
- `cryptography 42.0.8` is 4 major versions behind; security patches in 43.x–46.x remain unapplied.

#### deps-c4-5: OTel instrumentation still at beta 0.47b0 (small effort)
- **File:** `pyproject.toml:25-27`
- **Regression of:** deps-5 (marked complete, not applied)
- `opentelemetry-instrumentation-fastapi`, `-sqlalchemy`, `-celery` all remain at `0.47b0`; pre-release packages receive no CVE tracking.

#### deps-c4-6: SQLAlchemy `Session.bind` deprecated API (small effort, NEW)
- **File:** `app/services/search.py:69`
- `db.bind.dialect.name if db.bind else "sqlite"` uses the SQLAlchemy 1.4-deprecated `Session.bind` attribute. In SQLAlchemy 2.0.31 this emits `SADeprecationWarning` on every search call; it will be removed in a future major version, causing a hard `AttributeError` at runtime.

#### deps-c4-7: fastapi 0.111.0 significantly outdated (small effort, NEW)
- **File:** `pyproject.toml:10`
- FastAPI 0.111.0 was released in June 2024, approximately 18 months ago. FastAPI minor releases bundle Starlette security patches. The pinned version will not receive any upstream security fixes.

### LOW

#### deps-c4-8: pydantic 2.7.4 regression (trivial effort)
- **File:** `pyproject.toml:15`
- **Regression of:** deps-8 (marked complete, not applied)
- `pydantic 2.10+` validation correctness fixes not applied.

#### deps-c4-9: python-dotenv 1.0.1 regression (trivial effort)
- **File:** `pyproject.toml:16`
- **Regression of:** deps-9 (marked complete, not applied)

#### deps-c4-10: Missing app/api/__init__.py (trivial effort, NEW)
- **File:** `app/api/`
- Namespace package; mypy, coverage, and pytest import modes may behave incorrectly.

#### deps-c4-11: Missing app/schemas/__init__.py (trivial effort, NEW)
- **File:** `app/schemas/`
- Same concern as deps-c4-10.

---

## Comparison with Previous Scans

| Finding | Status in cycle 4 |
|---------|------------------|
| deps-1 (python-jose CVE, critical) | **REGRESSION** — pyproject.toml unchanged |
| deps-2 (jinja2 CVE, high) | **REGRESSION** — pyproject.toml unchanged |
| deps-3 (passlib abandoned, high) | Not re-checked; no evidence of fix |
| deps-4 (cryptography outdated, medium) | **REGRESSION** — pyproject.toml unchanged |
| deps-5 (OTel beta, medium) | **REGRESSION** — pyproject.toml unchanged |
| deps-6 (httpx outdated, medium) | **REGRESSION** — pyproject.toml unchanged |
| deps-7 (boto3 constraint, low) | Not re-checked (not in new findings) |
| deps-8 (pydantic outdated, low) | **REGRESSION** — pyproject.toml unchanged |
| deps-9 (python-dotenv, low) | **REGRESSION** — pyproject.toml unchanged |
| deps-c4-6 (Session.bind deprecated) | **NEW** |
| deps-c4-7 (fastapi outdated) | **NEW** |
| deps-c4-10 (missing api __init__) | **NEW** |
| deps-c4-11 (missing schemas __init__) | **NEW** |

**Confirmed still open from cycle 1:** 8 of 9 original findings
**New findings:** 4 (2 medium, 2 low)

---

## Top 3 Priority Fixes

1. **deps-c4-2 — Upgrade jinja2 to >=3.1.6** (trivial, HIGH CVE): One-line change in `pyproject.toml`, run `poetry update jinja2`. Immediately eliminates CVE-2024-56201 and CVE-2024-56326. No code changes needed.

2. **deps-c4-1 — Replace python-jose** (medium, HIGH CVE): Requires updating `pyproject.toml`, updating imports in `app/observability.py` and `app/services/auth_flow.py`, and verifying JWT encode/decode API compatibility. Eliminates CVE-2024-33664 and CVE-2024-33663.

3. **deps-c4-3 + deps-c4-4 — Upgrade httpx and cryptography together** (small, MEDIUM): Both are one-line `pyproject.toml` changes that can be batched in a single `poetry update httpx cryptography` run. Addresses webhook delivery security hardening and missing crypto patches.

---

## Root Cause: Fix Workflow Gap

The changelog commits `1ee0518` and `7f1dcc0` show that fix agents wrote documentation for deps-1 through deps-9 but `git log -- pyproject.toml` confirms the file was never modified. The fix-agent workflow for dependency upgrades needs to be audited: **agents must modify pyproject.toml and the lock file, not just the changelog**.

---

## Codebase Health: 61/100 (-6 from initial deps baseline)

Degradation is primarily driven by the systemic failure to apply any of the previous dependency fixes. The two NEW active CVEs (python-jose, jinja2) remain fully exploitable. The codebase is now in a worse position than before the deps cycle 1 scan because the false sense of completion from the changelog entries may have delayed escalation.
