# API Quality Scan — Cycle 3 (2026-02-27)

## Summary

**15 findings** across 20 API router files and `main.py`.

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High     | 5 |
| Medium   | 5 |
| Low      | 5 |

**Health Score: 65 / 100**
**Trend: First API-focused scan** (comparable: quality-cycle2 = 68/100, security-cycle2 = 63/100)

---

## Scan Focus

This scan targeted API-layer issues only:
- Missing `response_model` declarations
- Raw dict returns bypassing Pydantic
- Incorrect pagination metadata (page count ≠ total count)
- Inconsistent `get_db()` semantics across routers
- URL naming and router structure problems
- OpenAPI documentation gaps

---

## Findings by Severity

### HIGH (5)

| ID | File | Issue |
|----|------|-------|
| api-c3-1 | notifications.py:56 | POST /mark-read — no response_model, returns raw dict |
| api-c3-2 | notifications.py:62 | POST /mark-all-read — no response_model, returns raw dict |
| api-c3-3 | scheduler.py:64 | POST /tasks/refresh — no response_model |
| api-c3-4 | scheduler.py:69 | POST /tasks/{task_id}/enqueue — no response_model |
| api-c3-5 | auth.py:28 (×9 routers) | Simple get_db() without commit/rollback in 9 write-capable routers |

**api-c3-5 detail:** `auth`, `rbac`, `persons`, `scheduler`, `notifications`, `webhooks`, `settings`, `audit`, `search` all use `try/finally db.close()` with no `db.commit()` on success and no `db.rollback()` on exception. The nine ECM routers use the correct full pattern. Any service that does not call `db.commit()` internally (trusting the dependency to do it) will silently lose writes in the basic-pattern routers.

### MEDIUM (5)

| ID | File | Issue |
|----|------|-------|
| api-c3-6 | ecm_checkouts.py:52 | `response_model=dict` on checkin endpoint disables Pydantic validation |
| api-c3-7 | ecm_checkouts.py:78 | `count=len(items)` returns page size, not total |
| api-c3-8 | ecm_documents.py:130 | `count=len(items)` on list_versions returns page size, not total |
| api-c3-9 | audit.py:40 (systemic) | `order_by` accepts arbitrary strings; invalid values → 500 leaking schema |
| api-c3-10 | main.py:189 | Double router registration: every endpoint appears twice in OpenAPI |
| api-c3-11 | auth.py:25 | `APIRouter()` with no prefix; admin routes at root namespace |

**api-c3-7 and api-c3-8** are the same bug as quality-c2-12 (search.py) but affecting two additional endpoints that were not previously identified.

**api-c3-9** is systemic: all 20+ list endpoints use `order_by: str = Query(default=...)` with no allowlist constraint. An invalid column name (e.g. `?order_by=nonexistent`) causes an unhandled 500 that may reveal table structure.

**api-c3-10**: `_include_api_router()` in main.py registers every router at both `/` and `/api/v1`, doubling the OpenAPI schema entries. The `/docs` page shows 100+ duplicate paths.

### LOW (5)

| ID | File | Issue |
|----|------|-------|
| api-c3-12 | ecm_checkouts.py:61 | Redundant `get_checkout()` in checkin handler before service call |
| api-c3-13 | ecm_checkouts.py:71 | `GET /ecm/documents/checkouts` misplaced under documents prefix |
| api-c3-14 | scheduler.py:64 | Static `/tasks/refresh` declared after dynamic routes (ordering risk) |
| api-c3-15 | main.py:202 | Late imports mid-file (12 routers with `# noqa: E402`) |

---

## Comparison with Previous Findings

### New vs Previously Known

| Finding | Status |
|---------|--------|
| api-c3-1 through api-c3-4 (missing response_model) | NEW — not in quality-c2 or security scans |
| api-c3-5 (get_db inconsistency) | NEW — quality-c2-22 flagged duplication but not the semantic difference |
| api-c3-6 (response_model=dict) | NEW |
| api-c3-7, api-c3-8 (count=page size) | NEW — quality-c2-12 only covered search.py |
| api-c3-9 (order_by arbitrary string) | NEW |
| api-c3-10 (double registration) | NEW — structural issue not previously captured |
| api-c3-11 (missing router prefix) | NEW |
| api-c3-12 through api-c3-15 | NEW |

### Still Open from Previous Quality Scan

The following quality-c2 findings remain unresolved and directly affect the API layer:
- **quality-c2-8**: `list_sessions` in auth_flow.py has no pagination (unbounded `.all()`)
- **quality-c2-12**: search.py `count=len(items)` returns page count not total
- **quality-c2-22**: 18-way `get_db()` duplication (related to api-c3-5)
- **quality-c2-3**: N+1 in notifications.mark_read

---

## Top 3 Priority Fixes

### Priority 1: api-c3-5 — Inconsistent get_db() (HIGH, potential data loss)
This is the highest-impact finding. Nine routers performing write operations lack `db.commit()` in the dependency. If any underlying service (rbac, persons, webhooks, notifications, settings) doesn't call `db.commit()` explicitly, mutations are silently lost. This needs immediate service-layer audit to confirm correctness before the next release.

**Recommended fix:** Consolidate to a single `get_db()` in `app/db.py` (or `app/api/deps.py`) using the full commit/rollback/close pattern from the ECM routers, and remove all 18 per-file copies (resolves quality-c2-22 simultaneously).

### Priority 2: api-c3-1 + api-c3-2 + api-c3-3 + api-c3-4 — Missing response_model (HIGH, trivial effort)
Four action endpoints (`/mark-read`, `/mark-all-read`, `/tasks/refresh`, `/tasks/enqueue`) have no `response_model`, returning unvalidated raw dicts. These are trivial one-liner fixes for the two notifications endpoints. The scheduler endpoints need a new schema (small effort) but are equally important for contract stability.

### Priority 3: api-c3-9 — Arbitrary order_by (MEDIUM, systemic)
All list endpoints accept an arbitrary column name as `order_by`. A malformed value causes a 500 error that may expose internal ORM/table structure in the error detail. Fixing this centrally in `apply_ordering()` (already identified for deduplication in quality-c2-7) would resolve all instances at once.

---

## Codebase Health

**API layer health: 65 / 100**

Positive aspects:
- All CRUD endpoints have proper `response_model`, `status_code`, and pagination
- URL naming is consistent (kebab-case throughout)
- Pagination params uniformly validated (ge=1, le=N)
- Auth gating is consistently applied via `_include_api_router` dependencies
- Most endpoints use proper HTTP methods (PATCH for partial updates, DELETE for removes)

Deficit areas:
- Action endpoints (non-CRUD POSTs) frequently lack response_model (-8 pts)
- get_db() inconsistency creates correctness risk (-10 pts)
- Pagination count bug in 3 endpoints (-5 pts)
- Double OpenAPI registration (-7 pts)
- Missing input validation on order_by (-5 pts)

**Trend: Stable** (65 vs 68 quality scan — small difference attributable to different focus area)

---

## Auto-fixable Findings

5 of 15 findings are auto-fixable:
- api-c3-1: Add `response_model` to mark-read POST
- api-c3-2: Add `response_model` to mark-all-read POST
- api-c3-6: Replace `response_model=dict` with proper model on checkin
- api-c3-11: Add `prefix="/auth"` to auth.py APIRouter()
- api-c3-14: Reorder static route before dynamic route in scheduler.py
- api-c3-15: Move late imports to top of main.py
