# API Scan Report — Cycle 7
**Date:** 2026-02-27
**Scan type:** api
**Health score:** 58/100
**Trend:** degrading

---

## Summary

11 new findings: 0 critical, 3 high, 5 medium, 3 low.

All 15 cycle-3 API findings remain open (none were fixed between cycles). Combined with 11 new findings, the total unresolved API backlog is now **26 open findings**. The health score has dropped from 65 → 58, reflecting continued accumulation without remediation.

### Finding Breakdown

| Severity | New (c7) | Open from c3 | Total |
|----------|----------|--------------|-------|
| Critical | 0        | 0            | 0     |
| High     | 3        | 4            | 7     |
| Medium   | 5        | 5            | 10    |
| Low      | 3        | 6            | 9     |
| **Total**| **11**   | **15**       | **26**|

---

## What's New (cycle 7 only)

### High
- **api-c7-1** — `POST /auth/me/password` has no rate-limit dependency; brute-forceable current_password field with any valid JWT.
- **api-c7-2** — `GET /auth/me/sessions` loads all sessions with `.all()` and no pagination; unbounded memory growth per request.
- **api-c7-3** — `POST /ecm/document-retentions/{id}/dispose` takes `disposed_by` from request body, not auth context; any user can impersonate another as the disposal actor.

### Medium
- **api-c7-4** — `DELETE /auth/me/sessions` loads all sessions via `.all()` then loops to individually revoke; should use a single bulk UPDATE.
- **api-c7-5** — `DELETE /audit-events/{event_id}` hard-deletes immutable audit records, violating tamper-evidence requirements.
- **api-c7-6** — `GET /search` returns `count=len(items)` (page size, not total), continuing the pagination count bug pattern from c3 but in the search endpoint.
- **api-c7-7** — `PUT /settings/{domain}/{key}` accepts arbitrary key strings with no allowlist; enables creation of bogus settings rows.
- **api-c7-8** — Systemic: ~60 GET/{id}, PATCH/{id}, DELETE/{id} endpoints across all routers lack `responses={404: {"model": ErrorResponse}}`, leaving error contracts undocumented in OpenAPI.

### Low
- **api-c7-9** — `POST /ecm/documents/{id}/checkout` takes `checked_out_by` from body, not auth context (parallel IDOR to the cycle-6 checkin bypass).
- **api-c7-10** — `GET /notifications/unread-count` accepts `person_id` as a free query param with no ownership check (IDOR).
- **api-c7-11** — ~20 list-endpoint handlers annotate return type as `-> dict` instead of `ListResponse[...]`, breaking static type analysis.

---

## Still Open from Cycle 3 (not fixed)

All 15 findings from api-cycle3 remain unresolved:
- **api-c3-1/2** — `mark-read` and `mark-all-read` missing `response_model`
- **api-c3-3/4** — `/scheduler/tasks/refresh` and `/tasks/{id}/enqueue` missing `response_model`
- **api-c3-5** — `get_db()` pattern inconsistency across 18 router files (9 without commit/rollback)
- **api-c3-6** — `POST /ecm/documents/{id}/checkin` uses `response_model=dict`
- **api-c3-7/8** — Pagination count bugs in checkouts and versions list endpoints
- **api-c3-9** — `order_by` unvalidated across 20+ list endpoints (500 on invalid column)
- **api-c3-10** — Double router registration inflating OpenAPI docs
- **api-c3-11** — `auth.py` router has no prefix
- **api-c3-12** — Redundant `get_checkout()` DB round-trip in checkin handler
- **api-c3-13** — `/ecm/documents/checkouts` incorrect URL namespace
- **api-c3-14** — Route ordering (static before dynamic)
- **api-c3-15** — Late router imports in main.py

---

## Top 3 Priority Fixes

### 1. api-c7-1 — Rate-limit `POST /auth/me/password` (trivial effort)
Adding `Depends(_rate_limit_dependency("change_password", 5))` is a one-liner and closes a brute-force window that exists for any attacker who obtains a valid access token.

### 2. api-c7-3 — Derive `disposed_by` from auth context in dispose endpoint (small effort)
Taking actor identity from the request body is the same class of vulnerability as the checkin bypass (quality-c6-1). It allows audit trail falsification for document disposal events, which have legal implications in an ECM system.

### 3. api-c7-5 — Soft-delete audit events instead of hard-delete (small effort)
A `DELETE /audit-events/{id}` endpoint that actually deletes rows is a direct threat to audit-trail integrity. Adding a soft-delete guard is low-risk and closes a compliance hole with minimal disruption.

---

## Codebase Health

**Score: 58/100** (down from 65 in api-cycle3)

| Factor | Impact |
|--------|--------|
| 26 open API-layer findings | −26 |
| 3 high-severity new issues | −10 |
| 0 cycle-3 findings resolved | −6 (regression penalty) |
| All endpoints have response_model on CRUD routes | +5 |
| Consistent pagination on list endpoints | +4 |
| Rate limiting on most auth endpoints | +5 |

**Trend: degrading** — No API issues from cycle 3 were fixed; 11 new issues were discovered. The backlog is growing without remediation, and the rate-limit gap on `change_password` combined with the `disposed_by` IDOR represent meaningful regression in quality-gated security properties.
