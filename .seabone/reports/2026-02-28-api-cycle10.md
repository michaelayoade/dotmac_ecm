# API Scan Report — Cycle 10
**Date:** 2026-02-28
**Scan type:** API quality
**Files scanned:** 20 (`app/api/*.py`, supporting schemas)

---

## Summary

| Severity | Count |
|----------|-------|
| Critical | 0 |
| High     | 2 |
| Medium   | 6 |
| Low      | 3 |
| **Total**| **11** |

**Codebase health: 52/100**
**Trend: degrading** (previous api-cycle7: 58/100)

---

## Findings

### HIGH

**api-c10-1** — `app/api/search.py:21`
`q: str = Query(default="", min_length=0)` allows an empty query string. The service passes this to an ILIKE pattern that matches all records (`ILIKE '%%'`), triggering a full-table sequential scan on every empty-query request — a trivially exploitable DoS vector. Fix: enforce `min_length=1`.

**api-c10-2** — `app/schemas/notification.py:29`
`MarkReadRequest.notification_ids: list[UUID]` has no maximum length. A single authenticated request submitting thousands of UUIDs triggers an unbounded bulk UPDATE, enabling application-layer DoS. Fix: add `Field(max_length=100)`.

### MEDIUM

**api-c10-3** — `app/api/notifications.py:56`
`POST /notifications/mark-read` has no `response_model`. Returns `{"marked": count}` dict with no OpenAPI schema, no validation, no type contract.

**api-c10-4** — `app/api/notifications.py:62`
`POST /notifications/mark-all-read` has no `response_model`. Same issue — identical dict shape but undocumented.

**api-c10-5** — `app/api/scheduler.py:64`
`POST /scheduler/tasks/refresh` has no `response_model`. Returns opaque service dict with no documented schema.

**api-c10-6** — `app/api/scheduler.py:69`
`POST /scheduler/tasks/{task_id}/enqueue` has no `response_model`. Returns opaque enqueue result dict.

**api-c10-7** — `app/api/ecm_checkouts.py:71`
`GET /ecm/documents/checkouts` has only `limit`/`offset` — no `person_id`, `document_id`, or `status` filter. Clients cannot efficiently find who has a document checked out or all documents a given user has checked out.

**api-c10-8** — `app/api/ecm_collaboration.py:59` (and similar in ecm_workflows.py, ecm_retention.py)
`status_filter: str | None = Query(...)` accepts any string value for status filters. Invalid enum values silently return 0 results with HTTP 200 rather than a 422 validation error, making client bugs invisible.

### LOW

**api-c10-9** — `app/api/auth_flow.py:292`
Six handlers (`update_me`, `upload_avatar`, `delete_avatar`, `revoke_session`, `revoke_all_other_sessions`, `change_password`) call `db.commit()` directly inside endpoint functions, mixing persistence logic into the API layer and breaking the service/handler separation used elsewhere.

**api-c10-10** — `app/api/ecm_documents.py:66` (and all list endpoints)
All list handler return type annotations are `-> dict` while their `response_model` is `ListResponse[<EntityRead>]`. The mismatch means mypy cannot enforce that the returned dict matches the declared response schema.

**api-c10-11** — `app/api/auth_flow.py:157`
`POST /auth/mfa/setup` accepts `person_id` from the request body (actor-from-body anti-pattern); though protected by an ownership check, the field should be derived solely from the JWT and removed from the schema.

---

## Comparison with Previous Scans

### What's new (cycle 10)
- **Empty search query as DoS vector** (api-c10-1) — the ILIKE escaping fix from cycle 1 addressed injection but not empty-query full-table scans
- **notification_ids unbounded bulk write** (api-c10-2) — new DoS vector in MarkReadRequest schema
- **mark-read / mark-all-read missing response_model** (api-c10-3, api-c10-4) — action endpoints in notifications router; not covered by the checkin `response_model=dict` finding in quality-c9
- **Scheduler action endpoints missing response_model** (api-c10-5, api-c10-6) — refresh/enqueue return opaque service dicts
- **list_checkouts missing filter parameters** (api-c10-7) — every other list endpoint has at least one filter
- **status_filter string with no enum validation** (api-c10-8) — systemic pattern across collaboration, workflow, retention routers
- **auth_flow handlers committing directly** (api-c10-9) — analogous to quality-c9-8 (service self-commit) but in the API layer

### Still open from previous cycles
- Pagination count bug (`count=len(items)` instead of total count) — api-cycle7 / MEMORY
- Order_by unvalidated (500 on invalid column name) — api-cycle7 / MEMORY
- GET /me/sessions unbounded `.all()` — api-cycle7 / MEMORY
- POST /me/password missing rate limit — api-cycle7 / MEMORY
- Dispose actor-from-body (checkout, dispose) — multiple cycles / MEMORY
- Checkin `response_model=dict` — quality-c9-6 (unresolved)
- Workflow task complete no assignee check — quality-c9-2 (unresolved)
- ACL unenforced — MEMORY (structural, multi-cycle)

### No confirmed fixes since api-cycle7
No evidence of any api-cycle7 findings being resolved in the codebase.

---

## Top 3 Priority Fixes

1. **api-c10-1 — Empty search query DoS** (trivial, auto-fixable)
   One-line change: `q: str = Query(default=None, min_length=1)`. Prevents full-table scans with no other impact.

2. **api-c10-2 — MarkReadRequest.notification_ids unbounded** (trivial, auto-fixable)
   One-line change: `notification_ids: list[UUID] = Field(max_length=100)`. Caps bulk update blast radius.

3. **api-c10-3 + api-c10-4 — mark-read / mark-all-read missing response_model** (trivial, auto-fixable)
   Define `MarkReadResponse(count: int)` and wire it to both endpoints. Fixes the most user-visible schema gaps.

---

## Health Score

| Cycle | Score | Trend |
|-------|-------|-------|
| api-cycle3 | 65/100 | first scan |
| api-cycle7 | 58/100 | degrading |
| **api-cycle10** | **52/100** | **degrading** |

Score calculated from 11 new findings (2 high, 6 medium, 3 low) with no confirmed resolutions of prior open findings. The total open API finding count is estimated at 22+.
